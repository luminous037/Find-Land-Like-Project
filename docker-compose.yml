version: '3.8'

networks:
  security_net:
    driver: bridge
    ipam:
      config:
        # 클라이언트가 사용할 IP 대역 지정 (서버 IP 고정을 위함)
        - subnet: 172.20.0.0/24

services:
  server:
    build:
      context: ./server
      dockerfile: Dockerfile
    hostname: land-detector
    networks:
      security_net:
        ipv4_address: 172.20.0.2 # TARGET_SERVER_IP와 일치
    volumes:
      - ./server/data:/app/server/data
    ports:
      - "5000:5000/udp" # UDP 포트
    cap_add:
      - NET_ADMIN
      
    # 서버 시작 명령: rp_filter 비활성화 및 서버 실행
    command: >
        /bin/bash -c "
          echo 'Disabling rp_filter on server...' && \
          echo 0 > /proc/sys/net/ipv4/conf/all/rp_filter;
          /usr/local/bin/python /app/server.py
        "
      
  client:
      build:
        context: ./client
        dockerfile: Dockerfile
      hostname: attacker
      networks:
        security_net:
          ipv4_address: 172.20.0.3 # 클라이언트의 실제 IP
      
      cap_add:
        - NET_ADMIN
        
      # 역 경로 필터링 (rp_filter) 비활성화 (sysctls 대신 command에서 처리)

      # IP 포워딩 비활성화, FORWARD 체인 ACCEPT 규칙 추가
      command: >
        /bin/bash -c "
          echo 'Disabling rp_filter...' && \
          echo 0 > /proc/sys/net/ipv4/conf/all/rp_filter;
          
          echo 'Disabling ip_forward (Preventing routing and NAT)...' && \
          echo 0 > /proc/sys/net/ipv4/ip_forward; 

          echo 'Adding NAT bypass rule (ACCEPT 172.20.0.2) to FORWARD and NAT tables...' && \
          # 1. FORWARD 체인에 ACCEPT 규칙 추가 (라우팅 방지)
          iptables -t filter -I FORWARD 1 -s 172.20.0.2 -j ACCEPT;
          
          # 2. NAT POSTROUTING 규칙 (Source NAT 방지)
          iptables -t nat -I POSTROUTING 1 -s 172.20.0.2 -j ACCEPT;
          
          echo 'Rule applied. Starting client daemon...' && \
          /usr/bin/tail -f /dev/null
        "
      depends_on:
        - server